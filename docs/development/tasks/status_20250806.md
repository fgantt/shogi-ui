<state_snapshot>
    <overall_goal>
        Develop a browser-based Shogi game with an AI opponent, customizable settings, and a good user experience, specifically enabling flexible player type selection (Human/AI for both Player 1 and Player 2) and fixing related bugs.
    </overall_goal>

    <key_knowledge>
        - Shogi rules are understood and documented.
        - The AI uses a minimax algorithm with alpha-beta pruning and an opening book.
        - The opening book (`src/ai/openingBook.json`) maps SFEN-like board hashes to moves.
        - The UI is built with React components.
        - `PLAYER_1` and `PLAYER_2` constants define the players.
        - `getInitialGameState()` in `src/game/engine.js` sets the default board with Player 1 to move.
        - `StartGameModal.jsx` handles initial game settings.
        - `App.jsx` manages overall game state, player types, and interactions.
        - `player1Type` and `player2Type` state variables in `App.jsx` determine if a player is 'human' or 'ai'.
        - `generateStateHash` in `src/game/engine.js` is crucial for repetition detection and now correctly hashes the board state, captured pieces, and current player.
        - Player labels in captured pieces panels are dynamic: "Black" or "White" (English) / "Sente" or "Gote" (Kanji).
        - Shogi piece symbols (☗ for Black/Sente, <span style="color: white;">☗</span> for White/Gote) are used as prefixes for player labels.
        - Move history table now has 3 columns: Move Number, Player 1 Move, Player 2 Move.
        - Move history table auto-scrolls to the latest move.
        - Move history table styling:
            - Move number column: 20% width, right-aligned data, 0.5rem padding-right.
            - Player move columns: 40% width, left-aligned data, 1rem padding-left.
            - Headers: centered.
            - Background colors: worn paper aesthetic.
    </key_knowledge>

    <file_system_state>
        - CREATED/MODIFIED: `tasks/shogi-rules.md` - Populated with Shogi rules.
        - MODIFIED: `src/ai/ai.worker.js` - Integrated opening book, silenced console logs, added log for opening book moves.
        - MODIFIED: `src/ai/openingBook.json` - Expanded with Yagura opening data.
        - MODIFIED: `src/components/StartGameModal.jsx` - Updated to correctly capture `player1Type` and `player2Type` from the form.
        - DELETED: `src/styles/modal.css` - Styling moved to `settings.css`.
        - MODIFIED: `src/App.jsx` - Integrated `StartGameModal`, added `player1Type`/`player2Type` states, updated `handleStartGame`, AI turn logic, and interaction handlers; reset game state on new game; removed debug logs; modified `useEffect` hook to prevent AI logic from running when `StartGameModal` is open; updated `handleStartGame` to explicitly trigger Player 1's AI move if Player 1 is AI; updated repetition detection logic in `handlePlayerMove` and the AI `useEffect` hook; repositioned `CapturedPieces` components to be above and below the board; passed `currentBoardBackground` to `CapturedPieces` components; restructured `game-container` to place `MoveLog` alongside the board; removed `board-and-player1-captured` div and moved its contents to the parent `board-and-captured-pieces` div.
        - MODIFIED: `src/game/engine.js` - Reverted `getInitialGameState` to always set `currentPlayer` to `PLAYER_1`; modified `generateStateHash` to remove `moveHistory.length + 1` from the hash calculation.
        - MODIFIED: `src/components/Piece.jsx` - Fixed piece animation by wrapping `SvgPiece` in a `div`; removed `player` class from `piece-inner` div.
        - MODIFIED: `src/components/SvgPiece.jsx` - Added `player` prop and applied rotation directly to SVG element for `player2`.
        - MODIFIED: `src/components/CapturedPieces.jsx` - Implemented sorting of captured pieces by value; removed "Captured" from headings; dynamically set player labels ("Black"/"White" or "Sente"/"Gote"); added Shogi piece symbols (☗, ☗ (white)) as prefixes to headings; applied `boardBackground` as `backgroundImage` to the main div; corrected `player` class application to the outer div; corrected rendering of `<span>` for white symbol; added space between symbol and text in headers.
        - MODIFIED: `src/components/SettingsPanel.jsx` - Made "Board Background" and "Wallpaper" sections collapsible and start collapsed.
        - MODIFIED: `src/styles/settings.css` - Added CSS for collapsible sections.
        - CREATED: `tasks/status_20250804.md` - New status report.
        - MODIFIED: `src/components/GameControls.jsx` - Modified to ensure the "New Game" button is always enabled, even when AI is thinking.
        - MODIFIED: `src/components/MoveLog.jsx` - Removed "Time" column; changed player column to use Shogi symbols; restructured table body to display paired moves (Player 1 and Player 2); removed sortability from "Move" column and set header to blank; added `useRef` and `useEffect` for auto-scrolling.
        - MODIFIED: `src/styles/shogi.css` - Updated CSS for new `piece-inner` class; removed `ai-thinking-overlay` class definition and updated `thinking` class to only affect specific buttons; adjusted `game-container` and `captured-pieces` styles for horizontal layout; removed `transform: rotate(180deg)` from `.captured-pieces.player2`; added `rotate-180` class for `SvgPiece` rotation; modified `captured-pieces` styles for heading and pieces-list alignment (flex-direction, align-items, justify-content, order); removed `background-color` from `.captured-pieces`; added `background-color` and `padding` to `.captured-pieces h3` for banner effect; removed padding from `.captured-pieces`; added banner CSS to `.captured-pieces h3` (clip-path, display, position, padding-left); added specific banner CSS for `.captured-pieces.player2 h3` (clip-path, padding-right); removed `padding-left` from general `captured-pieces h3` and added it to `captured-pieces.player1 h3`; removed "Time" column related CSS; adjusted column widths for `move-table th` and `td` for the new 3-column layout; changed `game-container` to `flex-direction: row` and added `align-items: center`; adjusted `move-log` width and height; adjusted `move-table-container` and `move-table tbody` max-height; adjusted `move-table td:nth-child(1)` for right alignment and padding; adjusted `move-table th:nth-child(2)` and `th:nth-child(3)` for center alignment; adjusted `move-table td:nth-child(2)` for left alignment and padding; adjusted `move-table td:nth-child(3)` for left alignment and padding; changed background colors for `.move-log`, `.move-table tbody tr:nth-child(odd)`, `.move-table tbody tr:nth-child(even)`, and `.move-table th` to worn paper colors; added `gap: 10px;` to `.board-and-captured-pieces`.
    </file_system_state>

    <recent_actions>
        - Implemented and expanded the AI's opening book.
        - Added a startup dialog for game settings (difficulty, player type, piece set).
        - Fixed a bug where AI moved wrong pieces when Player 2 was human.
        - Fixed a visual bug with Player 2 piece animation.
        - Silenced console logs in AI and Board components.
        - Ensured game state resets properly on new game.
        - Made settings panel sections collapsible.
        - Added a console log to `ai.worker.js` when an opening book move is used.
        - Sorted captured pieces by value in `CapturedPieces.jsx`.
        - Fixed `StartGameModal` to correctly pass player types.
        - Ensured AI logic doesn't run prematurely.
        - Implemented auto-start for AI vs. AI games.
        - Made "New Game" button always active during AI turns.
        - Fixed the repetition draw detection by correcting the state hashing in `generateStateHash`.
        - Moved captured pieces panels above and below the board, oriented horizontally.
        - Corrected orientation of Player 2's captured pieces.
        - Refined heading and piece alignment within captured panels.
        - Changed player labels in captured panels to "Black"/"White" or "Sente"/"Gote".
        - Added Shogi piece symbols as prefixes to player labels.
        - Set captured panels background to match board background.
        - Added green banner background to heading text in captured panels.
        - Fixed rendering of white Shogi piece symbol.
        - Added space between Shogi symbol and text in captured pieces headers.
        - Removed padding from captured pieces container.
        - Applied banner styling to captured pieces headers.
        - Removed "Time" column from Move History.
        - Changed Move History player column to use Shogi symbols.
        - Restructured Move History to show paired moves (Player 1 and Player 2).
        - Moved Move History to the right of the board and made it board height.
        - Implemented auto-scroll for Move History.
        - Removed sortability from Move History's move number column.
        - Adjusted Move History column alignments and padding.
        - Changed Move History background colors to worn paper aesthetic.
        - Removed `board-and-player1-captured` div and moved its contents to the parent `board-and-captured-pieces` div.
        - Added `gap: 10px;` to `.board-and-captured-pieces`.
    </recent_actions>

    <current_plan>
        1. [TODO] Verify the updated UI layout, including captured pieces panel positioning, heading alignment, player labels, and background.
        2. [TODO] Verify the move history table layout, column headers, alignment, padding, auto-scroll, and new background colors.
    </current_plan>
</state_snapshot>